---
- name: "install dnsmasq"
  become: yes
  package:
    name: "dnsmasq"
    state: "present"

- name: "ensure directories"
  file:
    state: directory
    path: "{{ item }}"
    owner: "root"
    group: "root"
    mode: "u=rwx,g=rx,o=rx"
  become: yes
  loop:
    - "{{ _dnsmasq_additional_configuration_directory }}"
    - "{{ dnsmasq_tftp_directory }}"

- name: "populate TFTP server when PXE is enabled"
  include_tasks: "deploy_pxe.yml"
  when: dnsmasq_enable_pxe

- name: "prepare configuration files"
  become: yes
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "root"
    group: "root"
    mode: "u=rw,g=rw,o=r"
  loop:
    - src: "dnsmasq.conf.j2"
      dest: "/etc/dnsmasq.conf"
    - src: "hosts.j2"
      dest: "{{ _dnsmasq_hosts_configuration_file_path }}"
    - src: "aliases.j2"
      dest: "{{ _dnsmasq_additional_configuration_directory }}/aliases"
    - src: "static_leases.j2"
      dest: "{{ _dnsmasq_additional_configuration_directory }}/static_leases"
  register: _result_dnsmasq_config_files_generation

- name: "ensure that server is up and running"
  become: yes
  service:
    name: "dnsmasq"
    state: "{{ (_result_dnsmasq_config_files_generation is changed) | ternary('restarted', 'started') }}"
    enabled: yes


